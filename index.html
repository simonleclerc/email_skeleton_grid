<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="css/main.css"/>
</head>
<body>
<div id="contextMenu">
    <ul class="listMenu">
        <li class="addOptionTableInclude itemMenu" addOption="table_include">Include table</li>
        <li class="addOptionAlign itemMenu" addOption="align">Align</li>
    </ul>
    <ul class="listMenu">
        <li class="itemMenu listMenuMore">Inject code
            <ul class="listMenu">
                <li class="itemMenu">Code 1</li>
                <li class="itemMenu listMenuMore">Code 2
                    <ul class="listMenu">
                        <li class="itemMenu">Code 1</li>
                        <li class="itemMenu">Code 2</li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>
</div>
<button class="add_main">Add Main</button>
<button class="generate">Generate</button>
<label>Img root <input type="text" id="img_root" style="width: 500px;"/></label>
<div id="skeleton">
</div>
<div id="output"></div>
<textarea id="output_code"></textarea>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/ui.js"></script>
<script type="text/javascript">
    $(document).on('click', '.add_row',function(){
        gridGenerator.row($(this).closest('.main').children('ul'));
    });
    $(document).on('click', '.add_cell',function(){
        gridGenerator.cell($(this).closest('.row'));
    });
    $(document).on('click', '.add_main',function(){
        gridGenerator.main();
    });
    $(document).on('click', '.delete',function(){
        $(this).parent().remove();
    });
    $( ".sortable" ).sortable();

    var $renderedHTML;
    $(document).on('click','.generate', function(){
        $('#output').empty();
        $('#output_code').val('');
        $renderedHTML = $('<div></div>');
        $('body .main').each(function(i, e){
            var mainWidth = ($(e).find('.main_width').val() + '') || '650';
            $renderedHTML.append('<table width="'+mainWidth+'" id="table'+i+'" border="0" cellpadding="0" cellspacing="0" align="center" style="border-collapse: collapse;"></table>');
            $(e).find('.row').each(function(j,$row){
                $renderedHTML.find('#table'+i).append('<tr id="table'+i+'row'+j+'"><td><table border="0" cellpadding="0" cellspacing="0" align="center" width="100%" style="border-collapse: collapse;"><tr></tr></table></td></tr>');
                $($row).find('.cell').each(function(k, $cell){
                    $renderedHTML.find('#table'+i+'row'+j+' td table tr').append(
                            tableGenerator.cell({
                                'img': $($cell).find('.image_input').val(),
                                'bgc': $($cell).find('.bgc_input').val(),
                                'txt': $($cell).find('.txt_input')[0].checked,
                                'table_include': $($cell).find('.table_include').val()
                            })
                    );
                });
            });
        });
        $(document).trigger('construct.finish');
        setTimeout(function(){
            $('#output_code').val($renderedHTML.html());
            $('#output').empty().append($renderedHTML.html());
            //$renderedHTML = undefined;
        },3000);
    });

    var gridGenerator = {
        cell: function($elmParent){
            var $cell = $('<div class="cell"></div>');
            $cell.append('<label>IMG <input type="text" class="image_input"/></label>&nbsp;<label>BGC <input type="text" class="bgc_input"/></label><br/><label>Text <input type="checkbox" class="txt_input"/></label><button class="delete">x</button>');
            $elmParent.append($cell);
            $( ".sortable" ).sortable();
        },
        row: function($elmParent){
            var $row = $('<li class="row sortable"><button class="delete">x</button><button class="add_cell">+</button></li></li>');
            this.cell($row);
            $elmParent.append($row);
            $( ".sortable" ).sortable();
        },
        main: function(){
            var $main = $('<div class="main"><label>W <input class="main_width" type="text"/></label><button class="add_row">+</button><button class="delete">x</button><ul class="row_list sortable"></ul></div>')
            this.row($main.find('.row_list'));
            $('#skeleton').append($main);
        }

    };
    var addInput = function($elm, type, options){
        var $input;
        var $tempContainer = $('<div>');
        var $label = $('<label></label>');
        switch(type){
            case 'text':
                $input = $('<input/>');
                $input.attr('type', type);
                $input.addClass(options.class);
                $label.append(options.label).append($input);
                $tempContainer.append($label);
                break;
            case 'select':
                $input = $('<select></select>');
                for(option in options.optionsElm) {
                    $input.append('<option value="'+option+'">'+options.optionsElm[option]+'</option>');
                }
                $input.addClass(options.class);
                $label.append(options.label).append($input);
                $tempContainer.append($label);
                break;
            case 'checkbox':
            case 'radio':
                if(type == 'checkbox' && !options.optionsElm){
                    $input = $('<input/>');
                    $input.attr('type', type);
                    $input.addClass(options.class);
                    $label.append(options.label).append($input);
                    $tempContainer.append($label);
                } else {
                    var $fieldset = $('<fieldset></fieldset>');
                    var $legend = $('<legend>'+options.label+'</legend>');
                    $fieldset.append($legend);
                    for(option in options.optionsElm) {
                        $input = $('<input type="'+type+'" value="'+option+'" name="'+options.name+'" />');
                        $input.addClass(options.class);
                        $label.append(options.optionsElm[option]).append($input);
                        $fieldset.append($label);
                    }
                    $tempContainer.append($fieldset);
                }
                break;
        }
        options.beforeAppendCallback($tempContainer.children());

        $elm.append($tempContainer.children());
    };

    function addOptionCallback($addedElm){
        $($addedElm).addClass('option');
    }
    var addOption = function($elm, type){
        switch(type){
            case 'align':
                addInput($elm, 'select', {
                    beforeAppendCallback: addOptionCallback,
                    label: 'Align',
                    class: 'align',
                    optionsElm: {
                        left: 'left',
                        right: 'right',
                        center: 'center'
                    }
                });
                break;
            case 'table_include':
                addInput($elm, 'text', {
                    beforeAppendCallback: addOptionCallback,
                    label: 'Include ',
                    class: 'table_include'
                });
                break;
        }
        $('.'+type).closest('.option').attr('option', type);
    };
    var removeOption = function($elm, type){
        $elm.find('.'+type).closest('.option').remove();
    };

    var tableGenerator = {
        options: {
            img_root: $('#img_root').val()
        },
        cell: function(options){
            var img = options.img;
            var bgc = options.bgc;
            var text = options.txt;
            var table_include = options.table_include;
            var cell = $('<td></td>');
            cell.attr('align','left');
            bgc != '' ? cell.css('background-color', '#'+bgc) : '';

            if(table_include === '' || table_include === undefined ) {
                var link = $('<a></a>');
                link.attr('target', '_BLANK')
                        .attr('href', '#newLink')
                        .css({
                            fontFamily: 'Helvetica, Arial, sans-serif',
                            fontSize: '14px',
                            lineHeight: '16px',
                            textDecoration: 'none',
                            fontWeight: 'normal',
                            color: '#010101'
                        });

                cell.append(link);

                var workedImg;
                if (img !== '') {
                    var root = $('#img_root').val();
                    workedImg = root + img;
                    workedImg = workedImg.substr(workedImg.lastIndexOf('/') + 1);
                    var imgDom = new Image();
                }

                if (!text && img !== '') {
                    if (UrlExists(workedImg + '.jpg')) {
                        imgDom.onload = function () {
                            imgDom.setAttribute('alt', '');
                            imgDom.setAttribute('width', imgDom.width);
                            imgDom.setAttribute('height', imgDom.height);
                            imgDom.style.display = 'block';
                            if (imgDom.height < 20) {
                                cell.attr('height', imgDom.height);
                                cell.css('line-height', imgDom.height + 'px');
                            }
                            cell.find('a').append(imgDom);
                        };
                        imgDom.src = workedImg + '.jpg';
                    } else if (UrlExists(workedImg + '.gif')) {
                        imgDom.onload = function () {
                            imgDom.setAttribute('alt', '');
                            imgDom.setAttribute('width', imgDom.width);
                            imgDom.setAttribute('height', imgDom.height);
                            imgDom.style.display = 'block';
                            if (imgDom.height < 20) {
                                cell.attr('height', imgDom.height);
                                cell.css('line-height', imgDom.height + 'px');
                            }
                            cell.find('a').append(imgDom);
                        };
                        imgDom.src = workedImg + '.gif';
                    } else {
                        imgDom.onload = function () {
                            imgDom.setAttribute('alt', '');
                            imgDom.setAttribute('width', imgDom.width);
                            imgDom.setAttribute('height', imgDom.height);
                            imgDom.style.display = 'block';
                            if (imgDom.height < 20) {
                                cell.attr('height', imgDom.height);
                                cell.css('line-height', imgDom.height + 'px');
                            }
                            cell.find('a').append(imgDom);
                        };
                        imgDom.src = workedImg + '.png';
                    }
                } else if (text && img !== '') {
                    if (UrlExists(workedImg + '.jpg')) {
                        imgDom.onload = function () {
                            cell.attr('width', imgDom.width);
                        };
                        imgDom.src = workedImg + '.jpg';
                    } else if (UrlExists(workedImg + '.gif')) {
                        imgDom.onload = function () {
                            cell.attr('width', imgDom.width);
                        };
                        imgDom.src = workedImg + '.gif';
                    } else {
                        imgDom.onload = function () {
                            cell.attr('width', imgDom.height);
                        };
                        imgDom.src = workedImg + '.png';
                    }
                }

            } else {
                $(document).on('construct.finish', function(){
                    cell.append($renderedHTML.find('#table'+table_include));
                    $(document).off('construct.finish');
                });
            }
            return cell;
        }
    };
    function UrlExists(url)
    {
        var http = new XMLHttpRequest();
        http.open('HEAD', url, false);
        http.send();
        return http.status!=404;
    }

    gridGenerator.main();


    $(document).on('contextmenu','.cell', function(e){
        var mouse = {};
        var cellTargeted = e.target;
        mouse.x = e.clientX || e.pageX;
        mouse.y = e.clientY || e.pageY
        $('#contextMenu')
            .css({left: mouse.x, top: (mouse.y + document.body.scrollTop)})
            .show();

        var cellOptions = [];

        $(e.target).find('.option').each(function(){
            $('[addoption="'+$(this).attr('option')+'"]').addClass('alreadyPresent');
        });

        $('#contextMenu').on('click.addOption', function(e){
            if($(cellTargeted).find('.'+e.target.getAttribute('addOption')).length === 0){
                addOption($(cellTargeted), e.target.getAttribute('addOption'));
            }else{
                removeOption($(cellTargeted), e.target.getAttribute('addOption'));
            }
        });

        $(document).on('click.removeContextMenu', function(){
            $('#contextMenu').hide();
            $('.alreadyPresent').removeClass('alreadyPresent');
            $('#contextMenu').off('click.addOption');
            $(document).off('click.removeContextMenu');
        });

        return false;
    });


</script>
</body>
</html>